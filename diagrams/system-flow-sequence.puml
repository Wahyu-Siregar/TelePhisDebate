@startuml
title End-to-End Flow (Message to Action)

autonumber
skinparam sequenceMessageAlign center

actor "User" as User
participant "Telegram API" as Telegram
participant "TelePhisBot" as Bot
participant "MessageHandler" as Handler
participant "DetectionPipeline" as Pipeline
participant "RuleBasedTriage" as Triage
participant "SingleShotClassifier" as SingleShot
participant "MultiAgentDebate" as MAD
participant "BotActions" as Actions
database "Supabase" as DB

User -> Telegram : send message
Telegram -> Bot : update
Bot -> Handler : handle_message()
Handler -> Pipeline : process_message(text, metadata)

Pipeline -> Triage : analyze()
alt Triage skip_llm = true
  Pipeline --> Handler : result SAFE
else Continue
  Pipeline -> SingleShot : classify()
  alt high confidence decision
    SingleShot --> Pipeline : classification + confidence
  else escalate_to_mad
    Pipeline -> MAD : run_debate()
    MAD --> Pipeline : decision + confidence
  end
end

Pipeline -> Actions : execute_action()
Actions -> Telegram : warn/delete/notify
Handler -> DB : log detection + message
@enduml
